<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="user-scalable=0,width=device-width,initial-scale=1, minimum-scale=1, maximum-scale=1">
    <title>fabric.js定制按钮</title>
    <style>
        @font-face {
            font-family: 'zoolsBlack';
            src: url('../fonts/Zcool-Black.woff');
        }
        @font-face {
            font-family: 'zoolsHappy';
            src: url('../fonts/Zcool-Happy.woff');
        }
        @font-face {
            font-family: 'zoolsItalic01';
            src: url('../fonts/Italic01.ttf');
        }
        @font-face {
            font-family: 'zoolsItalic02';
            src: url('../fonts/Italic02.ttf');
        }
        body {
            margin: 0;
            text-align: center;
        }

        .main {
            margin: 0 auto;
            position: relative;
        }

        .design-area {
            margin: 0 auto;
            position: relative;
            background-image: url('https://www.teegether.cn/images/bgImages/tshirtShort_round_male_white_front.jpg');
            background-size: 100% 100%;
            transition: transform .3s;
        }

        .design-area.bigger {
            transform-origin: 50% 50%;
            transform: scale(1.7, 1.7);
        }

        #fabric_canvas {
            border: 1px solid #323232;
        }

        .print-area {
            position: absolute;
            top: 24.43%;
            left: 28.39%;
            width: 43.54%;
            height: 54.74%;
            border: 1px dashed #323232;
        }

        .print-area:after {
            content: '打印区域';
            position: absolute;
            left: 0;
            bottom: -20px;
            font-size: 10px;
        }

        #opreate {
            position: fixed;
            bottom: 0;
            /*background: #fff;*/
            width: 100%;
        }

        #word{
            width: 40px;
        }

        .canvas-container {
            margin: 0 auto;
        }

        button {
            padding: 5px;
            border:0;
            border-radius: 5px;
            margin: 10px;
        }
    </style>
</head>
<body>
<div class="main">
    <div class="design-area">
        <div class="print-area">

        </div>
        <canvas id="fabric_canvas"></canvas>
    </div>
    <div id="opreate" class="show">
        <label>
            添加图片:
            <button class="choose-photo" data-id="bear" value="../images/bear.jpg">bear</button>
            <button class="choose-photo" data-id="kobe" value="../images/11-2.jpg">kobe</button>
            <button class="choose-photo" data-id="chicken" value="../images/chicken.png">chicken</button>
            <button class="choose-photo" data-id="cat" value="../images/cat.jpg">cat</button>
        </label>
        <br>
        <label>
            添加文字：
            <input type="text" id="word">
            <input type="color" id="color">
            <select id="font_family">
                <option value="">选择字体</option>
                <option value="zoolsBlack">站酷黑体</option>
                <option value="zoolsHappy">站酷Happy</option>
                <option value="zoolsItalic01">zoolsItalic01</option>
                <option value="zoolsItalic02">zoolsItalic02</option>
            </select>
            <button id="addWord">+</button>
        </label>
        <br>
        <button onclick="window.location.reload()">reload</button>
        <button class="getActiveObject">获取选中对象</button>
        <button class="big_small">缩放</button>
        <!--<div id="info">-->

        <!--</div>-->
    </div>
</div>
<script type="text/javascript" src="../js/jquery.js"></script>
<script type="text/javascript" src="fabric.min.js"></script>
<!--<script type="text/javascript" src="fabric_with_gestures.js"></script>-->
<script type="text/javascript" src="customiseControls.min.js"></script>
<script>
    var w = window.screen.availWidth,
            h = window.screen.availHeight;
    w = w > 600 ? 600 : w;
    h = h > 600 ? 600 : h;

    var horizontalCenterLine, verticalCenterLine;

    $('.design-area').css({
        width: w,
        height: w
    });
    document.getElementById('fabric_canvas').width = w - 2;
    document.getElementById('fabric_canvas').height = w - 2;


    var canvas = new fabric.Canvas('fabric_canvas', {
                moveCursoe: 'move'
            }),
            ctx = canvas.getContext('2d');

    var canvas_w = canvas.width,
            canvas_h = canvas.height;
    //    绘画模式
    //    canvas.isDrawingMode = true;


    // 操作区域
    var print = {
        x: canvas_w * 0.2839,
        y: canvas_h * 0.2443,
        w: canvas_w * 0.4354,
        h: canvas_h * 0.5474,
    };

    print.center = {
        x: print.x + print.w / 2,
        y: print.y + print.h / 2
    };

    fabric.Canvas.prototype.customiseControls({
        tl: {
            action: 'rotate',
            cursor: 'pointer'
        },
        tr: {
            action: 'scale'
        },
        bl: {
            action: 'remove',
            cursor: 'pointer'
        },
        br: {
            action: 'moveUp',
            cursor: 'pointer'
        },
        mb: {
            action: 'moveDown',
            cursor: 'pointer'
        },
        mr: {
            action: function (e, target) {
                target.set({
                    left: w / 2,
                    top: h / 2
                });
                canvas.renderAll();
            },
            cursor: 'pointer'
        },
        mt: {
            action: {
                'rotateByDegrees': 45
            },
            cursor: 'pointer'
        }
    });
    // basic settings
    fabric.Object.prototype.customiseCornerIcons({
        settings: {
            borderColor: '#0094dd',
            cornerSize: 25,
            cornerShape: 'rect',
            cornerBackgroundColor: 'black'
        },
        tl: {
            icon: '../images/icons/rotate.svg'
        },
        tr: {
            icon: '../images/icons/resize.svg'
        },
        bl: {
            icon: '../images/icons/remove.svg'
        },
        br: {
            icon: '../images/icons/up.svg'
        },
        mb: {
            icon: '../images/icons/down.svg'
        },
        ml: {
            icon: '../images/icons/diagonal-resize.svg'
        },
        mr: {
            icon: '../images/icons/diagonal-resize.svg'
        }
    });

    addImg('../images/cat.jpg', 'cat');

    function addImg(url, id) {
        fabric.Image.fromURL(url, function (img) {
            var scale = print.w / img.getWidth() * .8;
            setObject(img, function () {
                img.set({
                    id: id,
                    left: canvas_w / 2,
                    top: canvas_h / 2,
                    scaleX: scale,
                    scaleY: scale,
                    originX: 'center',
                    originY: 'center',
                    centeredScaling: true,
                    hasRotatingPoint: false
                });
            });
        });
    }

    function setObject(object, setFun) {
        setFun && setFun();
        object.setControlsVisibility({
            ml: false,
            mr: false,
            mt: false
        });
        object.on('rotating', function () {
            autoAngle(this);
            drawRotationCircle(this);
        });
        object.on('moving', function () {
            var centerPiont = this.getCenterPoint(),
                    differ_x = centerPiont.x - print.center.x,
                    differ_y = centerPiont.y - print.center.y;
            //自动吸合辅助线
            if (Math.abs(differ_y) < 5) {
                this.setTop(centerPiont.y - differ_y);
                horizontalCenterLine || drawHorizontalCenterLine();
            } else {
                removeHorizontalCenterLine();
            }
            if (Math.abs(differ_x) < 5) {
                this.setLeft(centerPiont.x - differ_x);
                verticalCenterLine || drawVerticalCenterLine();
            } else {
                removeVerticalCenterLine();
            }

        });
        object.on('mouseup', function () {
            removeRotationCircle();
            removeHorizontalCenterLine();
            removeVerticalCenterLine();
        });
        object.on('selected', function () {
            var w = this.width,
                    h = this.height;

            object.clipTo = function () {
                ctx.rect(-w / 2, -h / 2, w, h);
            };
        });
        // modified 实时，性能
        // deselected 取消寻中执行
        object.on('modified', function () {
            this.clipTo = function () {
                this.setCoords();
                ctx.save();
                ctx.translate(-this.width / 2, -this.height / 2);
                ctx.rotate(-1 * this.angle * (Math.PI / 180));
                ctx.scale(1 / this.scaleX, 1 / this.scaleY);
                ctx.beginPath();
                ctx.rect(print.x - this.oCoords.tl.x, print.y - this.oCoords.tl.y, print.w, print.h);
                ctx.closePath();
                ctx.restore();
            };
        });
        // overwrite the prototype object based
        object.customiseCornerIcons({
            settings: {
                borderColor: 'black',
                cornerSize: 20,
                cornerShape: 'circle',
                cornerBackgroundColor: 'black',
                cornerPadding: 10
            },
            mt: {
                icon: '../images/icons/acute.svg'
            },
            mr: {
                icon: '../images/icons/repair-tools-cross.svg'
            }
        }, function () {
            canvas.renderAll();
        });
        canvas.add(object).setActiveObject(object);
    }

    //    按钮
    $('#word').focus(function () {
       $(this).val('') ;
    });

    $('.choose-photo').click(function () {
        addImg($(this).val(), $(this).attr('data-id'));
    });

    $('.getActiveObject').click(function () {
        console.log('选中' + canvas.getActiveObject().id);
    });

    $('.big_small').click(function () {
        $('.design-area').toggleClass('bigger');
    });

    $('#addWord').click(function () {
        addWord($('#word').val())
    });

    //添加文字
    function addWord(text) {
        var word = new fabric.Text(text, {
            left: canvas_w / 2,
            top: canvas_h / 2,
            originX: "center",
            originY: "center",
            textAlign: "center",
            fontFamily:$('#font_family').val(),
            fontSize: 30,
            lineHeight: 1.3,
            fill: $('#color').val(),
            backgroundColor: "transparent",
            hasRotatingPoint: false
        });
        setObject(word)
    }
    //辅助圆drawRotationCircle
    var assistWord, assistCircle;
    function drawRotationCircle(t) {
        //t:fabric.object
        var angle = Math.round(t.getAngle()),
                i = angle % 45 == 0;
        var centerPoint = t.getCenterPoint(),

                radius = Math.sqrt(Math.pow(t.getWidth() / 2, 2) + Math.pow(t.getHeight() / 2, 2));
        if (assistWord) {
            assistWord.set({
                left: centerPoint.x,
                top: centerPoint.y - radius - 10,
                text: angle + "º",
                fill: i ? "#fff" : "#00B2A5",
                backgroundColor: i ? "#00B2A5" : "transparent"
            });
            assistCircle.set({
                radius: radius
            });
        } else {
            //角度文字
            assistWord = new fabric.Text(angle + "º", {
                left: centerPoint.x,
                top: centerPoint.y - radius - 10,
                selectable: !1,
                originX: "center",
                originY: "center",
                textAlign: "center",
                fontSize: 12,
                lineHeight: 1.3,
                fill: i ? "#fff" : "#00B2A5",
                backgroundColor: i ? "#00B2A5" : "transparent"
            });
            //辅助圆
            assistCircle = new fabric.Circle({
                fill: "transparent",
                stroke: "#00B2A5",
                strokeWidth: 1,
                selectable: !1,
                left: centerPoint.x,
                top: centerPoint.y,
                radius: radius,
                originX: "center",
                originY: "center"
            });
            canvas.add(assistWord).add(assistCircle)
        }
    }
    function removeRotationCircle() {
        canvas.remove(assistWord).remove(assistCircle);
        assistWord = '';
        assistCircle = '';
    }
    function autoAngle(t) {
        var angle = Math.round(t.getAngle()),
                n = angle % 45;
    //5度内吸合
        n < 5 && t.setAngle(angle - n);
        n > 40 && t.setAngle(angle + 45 - n);
    }
    //辅助线
    function drawHorizontalCenterLine() {
        horizontalCenterLine = new fabric.Line([0, print.center.y, canvas_w, print.center.y], {
            stroke: "#00B2A5",
            strokeWidth: 1,
            selectable: !1,
            width: 0,
            height: 0
        });
        canvas.add(horizontalCenterLine)
    }
    function drawVerticalCenterLine() {
        verticalCenterLine = new fabric.Line([print.center.x, 0, print.center.x, canvas_h], {
            stroke: "#00B2A5",
            strokeWidth: 1,
            selectable: !1,
            width: 0,
            height: 0
        });
        canvas.add(verticalCenterLine)
    }
    function removeHorizontalCenterLine() {
        canvas.remove(horizontalCenterLine);
        horizontalCenterLine = '';
    }
    function removeVerticalCenterLine() {
        canvas.remove(verticalCenterLine);
        verticalCenterLine = '';
    }

</script>
</body>
</html>